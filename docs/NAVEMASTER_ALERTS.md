# NAVEMASTER V2 Alerts (per Run)

This document describes the alert rules generated by `navemaster_compute_run_v2` and the expected evidence JSON shape.

## Alerts

### MISSING_IN_CORE
Baseline INCA cable has no approved CORE proof in the run window.

Evidence:
- `reason`: `"no_approved_proof"`
- `metri_ref`
- `stato_nav`

### EXTRA_IN_CORE
Approved CORE proof exists but cable is absent from the baseline INCA file of the run.

Evidence:
- `reason`: `"proof_without_baseline"`
- `metri_posati_ref`
- `last_proof_at`
- `inca_file_id`

### DUPLICATE_IN_INCA
Duplicate `codice_norm` inside baseline INCA for the run.

Evidence:
- `reason`: `"duplicate_codice_norm"`
- `count`
- `codici` (array of raw `codice`)

### STATUS_CONFLICT
Status/event conflicts with proofs or blocco state.

Rules:
- `E` with `metri_posati_ref > 0`
- `R` or `L` with `metri_posati_ref > 0`
- `B` event where blocco is inactive/closed (`unblocked_at` not null)

Evidence:
- `reason`: `"E_with_posati" | "R_or_L_with_posati" | "B_inactive_blocco"`
- `metri_posati_ref`
- `metri_ref`
- `last_proof_at`
- `blocco_locale_id`
- `blocco_active`
- `unblocked_at`
- `event_at`

### METRI_MISMATCH
Meters inconsistencies.

Rules:
- `metri_posati_ref > metri_ref`
- negative values
- `metri_ref` missing/0 while status is not `E`

Evidence:
- `reason`: `"posati_gt_ref" | "negative_value" | "ref_missing_or_zero"`
- `metri_ref`
- `metri_posati_ref`
- `stato_nav`

### BLOCKED_IMPACT
Status `B` with active blocco only.

Rule:
- `stato_nav = 'B'` and latest `B` event has `blocco_active = true` (`unblocked_at` is null)

Evidence:
- `reason`: `"status_B_active_blocco"`
- `metri_ref`
- `delta_metri`
- `blocco_locale_id`

## Verification SQL

Counts by alert type for a run:
```sql
select type, count(*)
from public.navemaster_alerts
where run_id = :run_id
group by type
order by type;
```

Example evidence per type:
```sql
select type, evidence
from public.navemaster_alerts
where run_id = :run_id
order by created_at desc
limit 20;
```

Verify BLOCKED_IMPACT only for active blocchi:
```sql
select a.codice, a.evidence
from public.navemaster_alerts a
where a.run_id = :run_id
  and a.type = 'BLOCKED_IMPACT';
```
